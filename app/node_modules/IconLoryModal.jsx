import { Component } from 'react/lib/React'
import { lory } from 'lory.js/src/lory'

export default class IconLoryModal extends Component {
   static defaultProps = {
      links: [],
   }

   componentLoaded = () => {
      this.modal = $(this.$modal).modal().modal('getInstance')
      let lory_settings = {
         slideSpeed: 750,
         ease: 'cubic-bezier(0.455, 0.03, 0.515, 0.955)',
      }
      let items_width = [...this.$modal.querySelectorAll('li')].reduce((width, img) => {
         return width + img.offsetWidth //+ 8 as gap? TODO
      }, 0)

      if (items_width > this.$modal.clientWidth) {
         // lory_settings.infinite = 1
         this.lory_scroll = true
         lory_settings.rewind = true
      } else {
         this.$modal.style.width = items_width + "px;"
         this.$modal.querySelector('.prev').className += ' hidden'
         this.$modal.querySelector('.next').className += ' hidden'
      }

      this.lory = lory(this.$lory, lory_settings)
   }

   componentDidMount = () => {
      this.lory_scroll = false

      window.addEventListener('load', this.componentLoaded.bind(this))
      document.addEventListener('click', this.onDocumentClick.bind(this))
   }

   componentWillUnmount = () => {
      document.removeEventListener('load', this.componentLoaded.bind(this))
      document.removeEventListener('click', this.onDocumentClick.bind(this))
   }

   openModal = (index) => {
      if (this.lory_scroll) {
         this.lory.slideTo(index, 0)
      }

      this.modal.open()
   }

   onDocumentClick = (e) => {
      if (! e.cancelBubble && this.modal.isOpen && ! e.target.closest('.modal')) {
         this.modal.close()
      }
   }

   render = () => {
      return (
         <div
            className='modal'
            id='slider-modal'
            ref={$modal => this.$modal = $modal} >
            <div className='modal-content'>
               <div
                  className='lory_slider js_lory_slider'
                  ref={$lory => this.$lory = $lory} >
                  <div className='frame js_frame'>
                     <ul className='slides js_slides'>
                        {this.props.links.map((link) =>
                           <li
                              key={link.id} >
                              <img
                                 className='icon'
                                 src={link.url}
                                 alt={link.description} /></li>)}</ul></div>
                  <div className='js_prev prev waves-effect'>
                     <svg 
                        xmlns="http://www.w3.org/2000/svg"
                        width="50"
                        height="50"
                        viewBox="0 0 501.5 501.5">
                        <g>
                           <path
                              fill="#DEB3AA"
                              d="M302.67 90.877l55.77 55.508L254.575 250.75 358.44 355.116l-55.77 55.506L143.56 250.75z" /></g></svg></div>
                  <div className='js_next next waves-effect'>
                     <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="50"
                        height="50"
                        viewBox="0 0 501.5 501.5">
                        <g>
                           <path
                              fill="#DEB3AA"
                              d="M199.33 410.622l-55.77-55.508L247.425 250.75 143.56 146.384l55.77-55.507L358.44 250.75z" /></g></svg></div>
                  <a
                     className='modal-action modal-close waves-effect btn-flat pulse chip'
                     href="javascript:">
                        Закрыть</a></div></div></div>)}}
